<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NDIS Drone Mission Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --font:"Avenir Next",Avenir,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      --bg:#f5f7fa;--panel:#e9eef6;--panel-2:#d7e4f7;--primary:#0066cc;--primary-hover:#004c99;
      --text:#0f172a;--muted:#475569;--radius:12px;--shadow:0 2px 16px rgba(0,0,0,.08);
    }
    html,body{height:100%}
    body{margin:0;padding:20px;background:var(--bg);color:var(--text);font-family:var(--font);font-size:14px;line-height:1.45;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    *,*::before,*::after{font-family:var(--font)!important}
    .container{max-width:820px;margin:0 auto}
    .card{border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:14px}
    .card.alt{background:var(--panel)} .card.soft{background:var(--panel-2)}
    .card.form{background:var(--panel)} .card.results{background:var(--panel-2)}
    h1{margin:0 0 10px;font-size:22px;font-weight:700} h2{margin:0 0 8px;font-size:18px;font-weight:700} h3{margin:0 0 6px;font-size:16px;font-weight:700}
    p,ol,ul{margin:6px 0}
    .kbd{display:inline-block;padding:0 6px;border-radius:6px;border:1px solid #cbd5e1;background:#f8fafc;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace!important;font-size:12px}
    .form-grid{display:grid;grid-template-columns:1fr;gap:10px}
    label{display:block;font-weight:600;margin:0 0 2px;font-size:14px}
    input,select,button{font-size:14px;line-height:1.2;height:36px;width:100%;padding:8px 10px;border-radius:8px;border:1px solid #cbd5e1;background:#fff;outline:none;box-sizing:border-box}
    select,option{font-size:14px}
    input:focus,select:focus{border-color:var(--primary);box-shadow:0 0 0 2px rgba(0,102,204,.15)}
    ::placeholder{color:#94a3b8;font-size:13px}
    .actions{display:flex;gap:8px;justify-content:center;margin-top:10px}
    button{background:var(--primary);color:#fff;font-weight:700;cursor:pointer;border:0;height:36px}
    button:hover{background:var(--primary-hover)}
    .secondary{background:transparent;color:var(--primary);border:2px solid var(--primary)}
    .secondary:hover{background:rgba(0,102,204,.06)}
    .results-box{background:#eef5ff;border-radius:var(--radius);box-shadow:var(--shadow);padding:10px;min-height:40px}
    .muted{color:var(--muted)} .error{color:#b91c1c;font-weight:600}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:#ffffffcc;border:1px solid #cbd5e1;border-radius:999px;padding:2px 8px;font-size:13px}
    .kv{margin:3px 0} .kv b{display:inline-block;min-width:180px}
    .drone-row{background:#fff;border-radius:10px;box-shadow:0 1px 8px rgba(0,0,0,.05);padding:10px;margin:6px 0}
    .drone-row .title{font-weight:700;margin-bottom:2px}
    .links{margin-top:3px} .links a{color:var(--primary);text-decoration:none;font-size:14px}
    .links a:hover{text-decoration:underline}
    .drone-img{width:100%;max-width:520px;height:auto;border-radius:10px;display:block;margin:6px 0 8px 0;box-shadow:0 1px 8px rgba(0,0,0,.05)}
  </style>
</head>
<body>
  <div class="container">
    <div class="card alt">
      <h1>Natural Disaster Information System (NDIS)</h1>
      <p class="muted">Welcome to the Natural Disaster Information System (NDIS) – click any point on the map to explore nearby hazards.</p>
      <h3>How to explore hazards in the map</h3>
      <ol>
        <li>Click a point on the map.</li>
        <li>In the pop-up, click the <span class="kbd">Action ⦂⦂</span> icon in the upper left.</li>
        <li>Click <span class="kbd">Related data</span>.</li>
        <li>Expand the related table (click <span class="kbd">⏵︎</span>) in each <span class="kbd">OBJECTID</span> to view precomputed sensor and drone recommendations tied to that hazard.</li>
      </ol>
      <p>Or on the sidebar, there are already top 3 sensors and top 3 drones for each hazard point’s recommendation.</p>
    </div>

    <div class="card soft">
      <h2>User override</h2>
      <p>Fill the form below to find a drone recommendation using your own inputs.</p>
    </div>

    <div class="card form">
      <h2>Mission Inputs</h2>
      <div class="form-grid">
        <div>
          <label for="distance_to_road">Distance to nearest road (to base) (m)</label>
          <input type="number" id="distance_to_road" inputmode="numeric" min="0" step="1" placeholder="e.g. 1200"/>
        </div>
        <div>
          <label for="area_length">Area length (m)</label>
          <input type="number" id="area_length" inputmode="numeric" min="0" step="1" placeholder="e.g. 1000"/>
        </div>
        <div>
          <label for="area_width">Area width (m)</label>
          <input type="number" id="area_width" inputmode="numeric" min="0" step="1" placeholder="e.g. 400"/>
        </div>
        <div>
          <label for="spacing">Line spacing (m)</label>
          <input type="number" id="spacing" inputmode="numeric" min="1" step="1" placeholder="e.g. 20"/>
        </div>
        <div>
          <label for="geohazard_type">Geohazard type</label>
          <select id="geohazard_type">
            <option>Volcano</option><option>Earthquake</option><option>Fault</option>
            <option>Landslide</option><option>Tsunami</option><option>Nuclear</option>
          </select>
        </div>
        <div>
          <label for="hazard_stage">Disaster stage</label>
          <select id="hazard_stage">
            <option>Pre-Event</option><option>During</option><option>Post-Event</option><option>Clean-Up</option>
          </select>
        </div>
        <div>
          <label for="sensor">Sensor (override)</label>
          <select id="sensor">
            <option value="">Auto-select</option>
            <option>Seismic</option><option>Magnetometers</option><option>Camera</option>
            <option>Thermal Camera</option><option>LiDAR</option><option>GPR</option>
            <option>BPR</option><option>Gamma Spectrometer</option>
          </select>
        </div>
      </div>
      <div class="actions">
        <button onclick="submitMission()">Submit mission</button>
        <button class="secondary" onclick="resetForm()">Reset</button>
      </div>
    </div>

    <div class="card results">
      <h2>Results</h2>
      <div id="results" class="results-box muted">No results yet.</div>
    </div>
  </div>

  <script>
    function getNumber(id){const v=document.getElementById(id).value;if(v===""||v===null)return null;const n=Number(v);return Number.isFinite(n)?n:null;}
    function resetForm(){["distance_to_road","area_length","area_width","spacing"].forEach(id=>document.getElementById(id).value="");["geohazard_type","hazard_stage","sensor"].forEach(id=>document.getElementById(id).selectedIndex=0);const r=document.getElementById("results");r.classList.add("muted");r.innerHTML="No results yet.";window.__lastMissionResult=null;}

    async function submitMission(){
      const r=document.getElementById("results");r.classList.remove("muted");r.innerHTML="Processing…";
      const distance_to_road=getNumber("distance_to_road"),area_length=getNumber("area_length"),area_width=getNumber("area_width"),spacing=getNumber("spacing");
      if(distance_to_road===null||distance_to_road<0){r.innerHTML=`<span class="error">Error:</span> Distance to nearest road must be a non-negative number.`;return;}
      if(area_length!==null&&area_length<0){r.innerHTML=`<span class="error">Error:</span> Area length cannot be negative.`;return;}
      if(area_width!==null&&area_width<0){r.innerHTML=`<span class="error">Error:</span> Area width cannot be negative.`;return;}
      if(spacing!==null&&spacing<=0){r.innerHTML=`<span class="error">Error:</span> Line spacing must be greater than zero.`;return;}

      const body={distance_to_road,area_length,area_width,spacing,
        geohazard_type:document.getElementById("geohazard_type").value,
        hazard_stage:document.getElementById("hazard_stage").value,
        sensor:document.getElementById("sensor").value||null,
        latitude:null,longitude:null,radius:null};

      try{
        const res=await fetch("/mission",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
        const ct=res.headers.get("content-type")||"";
        const raw=await res.text();
        if(!res.ok){throw new Error(`${res.status} ${res.statusText} — ${raw.slice(0,200)}`);}
        let data;
        if(ct.includes("application/json")){data=JSON.parse(raw);}
        else{throw new Error(`Unexpected content-type: ${ct} — ${raw.slice(0,200)}`);}
        window.__lastMissionResult=data; renderResultsCompact(data);
      }catch(err){
        r.innerHTML=`<span class="error">Server error:</span> ${escapeHtml(err?.message||"Unknown error.")}`;
      }
    }

    function renderResultsCompact(data){
      const el=document.getElementById("results");
      if(!data||data.error){el.innerHTML=`<span class="error"><b>Error:</b></span> ${escapeHtml(data?.error||"No data returned.")}`;return;}
      let html=``;

      if(data.mission_overview){html+=`<div class="card" style="background:#fff;margin:0 0 8px 0;"><h3>Mission Summary</h3><p>${escapeHtml(data.mission_overview)}</p></div>`;}
      if(Array.isArray(data.top3_sensors)&&data.top3_sensors.length){html+=`<div class="card" style="background:#fff;margin:0 0 8px 0;"><h3>Top 3 Sensors</h3><div class="chips">`;data.top3_sensors.forEach(s=>{html+=`<span class="chip">${escapeHtml(s)}</span>`});html+=`</div></div>`;}

      if(data.best_combo&&data.best_combo.mfc_model){
        const b=data.best_combo;
        html+=`<div class="card" style="background:#fff;margin:0 0 8px 0;"><h3>Best Combination</h3>
          <div class="kv"><b>Pair:</b> ${escapeHtml(b.sensor||"Sensor")} + ${escapeHtml(b.mfc_model)}</div>
          <div class="kv"><b>Manufacturer:</b> ${escapeHtml(b.manufacturer||"—")}</div>
          <div class="kv"><b>Configuration:</b> ${escapeHtml(b.configuration_harmonized||"—")}</div>
          <div class="kv"><b>Comm range:</b> ${safeNum(b.comm_range)} m</div>
          <div class="kv"><b>Distance range:</b> ${safeNum(b.distance_range)} m</div>
          <div class="kv"><b>Payload:</b> ${safeNum(b.max_payload_weight)} g</div>
          <div class="kv"><b>Flight time:</b> ${safeNum(b.flight_time)} min</div>
          <div class="kv"><b>Swaths needed:</b> ${safeNum(b.swaths_needed)}</div>
          <div class="kv"><b>Max GCS distance:</b> ${safeNum(b.max_gcs_distance_m)} m</div>
          <div class="kv"><b>Price:</b> ${b.price?("$"+Number(b.price).toLocaleString()):"—"}</div>
          ${b.source?`<div class="links"><a href="${escapeAttr(b.source)}" target="_blank" rel="noopener">View drone details</a></div>`:""}
          ${b.image?`<img class="drone-img" src="${escapeAttr(b.image)}" loading="lazy" alt="${escapeAttr(b.mfc_model||'drone')}"/>`:""}
        </div>`;
      }

      if(Array.isArray(data.mission_summary)){
        data.mission_summary.forEach(section=>{
          html+=`<div class="card" style="background:#fff;margin:0 0 8px 0;">
            <h3>${escapeHtml(section.sensor||"Sensor")} — ${escapeHtml(section.mission_type||"")}</h3>
            <div class="muted" style="margin-bottom:4px;">${escapeHtml(section.mission_text||"")}</div>
            <div class="kv"><b>Mission flight path:</b> ${safeNum(section.mission_distance_m)} m</div>`;
          if(section.sensor_meta&&(section.sensor_meta.model||section.sensor_meta.source||section.sensor_meta.sensor_weight)){
            html+=`<div class="kv"><b>Sensor details:</b>
              ${section.sensor_meta.model?`Model ${escapeHtml(section.sensor_meta.model)} · `:""}
              ${section.sensor_meta.sensor_weight?`${safeNum(section.sensor_meta.sensor_weight)} g · `:""}
              ${section.sensor_meta.source?`<a href="${escapeAttr(section.sensor_meta.source)}" target="_blank" rel="noopener">View sensor details</a>`:""}
            </div>`;
          }
          if(Array.isArray(section.top3_drones)&&section.top3_drones.length){
            section.top3_drones.forEach(d=>{
              html+=`<div class="drone-row">
                <div class="title">${escapeHtml(d.mfc_model||"Drone")}</div>
                <div class="kv"><b>Manufacturer:</b> ${escapeHtml(d.manufacturer||"—")}</div>
                <div class="kv"><b>Configuration:</b> ${escapeHtml(d.configuration_harmonized||"—")}</div>
                <div class="kv"><b>Comm range:</b> ${safeNum(d.comm_range)} m</div>
                <div class="kv"><b>Distance range:</b> ${safeNum(d.distance_range)} m</div>
                <div class="kv"><b>Payload:</b> ${safeNum(d.max_payload_weight)} g</div>
                <div class="kv"><b>Flight time:</b> ${safeNum(d.flight_time)} min</div>
                <div class="kv"><b>Swaths needed:</b> ${safeNum(d.swaths_needed)}</div>
                <div class="kv"><b>Max GCS distance:</b> ${safeNum(d.max_gcs_distance_m)} m</div>
                <div class="kv"><b>Price:</b> ${d.price?("$"+Number(d.price).toLocaleString()):"—"}</div>
                ${d.source?`<div class="links"><a href="${escapeAttr(d.source)}" target="_blank" rel="noopener">View drone details</a></div>`:""}
                ${d.image?`<img class="drone-img" src="${escapeAttr(d.image)}" loading="lazy" alt="${escapeAttr(d.mfc_model||'drone')}"/>`:""}
                ${d.note?`<div class="muted">${escapeHtml(d.note)}</div>`:""}
              </div>`;
            });
          } else { html+=`<p class="muted">No drone candidates.</p>`; }
          html+=`</div>`;
        });
      }

      if(data.logistics){html+=`<div class="card" style="background:#fff;"><h3>Mission logistics</h3><p>${escapeHtml(data.logistics)}</p></div>`;}
      el.innerHTML=html;
    }

    function safeNum(v){return(typeof v==="number"&&isFinite(v))?v:"—";}
    function escapeHtml(s){if(s===null||s===undefined)return"";return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");}
    function escapeAttr(s){if(s===null||s===undefined)return"";return String(s).replace(/"/g,"&quot;");}
  </script>
</body>
</html>
